@model AgendaIR.Models.ViewModels.AgendamentoCreateViewModel

@{
    ViewData["Title"] = "Novo Agendamento";
}

<!-- PAGE HEADER -->
<div class="page-header-rir">
    <div>
        <h2><i class="bi bi-calendar-plus"></i> Novo Agendamento</h2>
        <p>Preencha as informações para agendar seu atendimento IR</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-12 col-lg-10">
        <div class="card-rir">
            <div class="card-rir-body">
                <form asp-action="Create" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    
                    <div asp-validation-summary="ModelOnly" class="alert-rir alert-rir-danger" role="alert"></div>

                    <!-- FUNCIONÁRIO RESPONSÁVEL -->
                    <div class="mb-4">
                        <label asp-for="FuncionarioId" class="form-label fw-bold">
                            <i class="bi bi-person-badge"></i> Funcionário Responsável
                        </label>
                        <select asp-for="FuncionarioId" 
                                class="form-select" 
                                asp-items="@(new SelectList(ViewBag.Funcionarios, "Id", "Nome"))"
                                onchange="onFuncionarioChange(this.value)"
                                required>
                            <option value="">-- Selecione --</option>
                        </select>
                        <span asp-validation-for="FuncionarioId" class="text-danger"></span>
                        <small class="form-text text-muted">
                            <i class="bi bi-info-circle"></i> Este é o funcionário que irá atendê-lo
                        </small>
                    </div>

                    <!-- DATA E HORÁRIO -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar-event"></i> Data e Horário
                        </label>
                        
                        <div class="data-hora-container">
                            <!-- Calendário (Esquerda) -->
                            <div class="calendario-wrapper">
                                <div id="calendario"></div>
                            </div>
                            
                            <!-- Horários Disponíveis (Direita) -->
                            <div class="horarios-wrapper">
                                <div id="horarios-disponiveis">
                                    <div class="alert-rir alert-rir-info">
                                        ℹ️ Selecione um dia no calendário
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo hidden para enviar no POST -->
                        <input type="hidden" asp-for="DataHora" id="DataHora" />
                        <span asp-validation-for="DataHora" class="text-danger"></span>
                        
                        <!-- Confirmação visual -->
                        <div id="confirmacao-horario" class="mt-2"></div>
                    </div>

                    <!-- Observações -->
                    <div class="mb-4">
                        <label asp-for="Observacoes" class="form-label fw-bold">
                            <i class="bi bi-chat-text"></i> Observações (Opcional)
                        </label>
                        <textarea asp-for="Observacoes" class="form-control" rows="3" 
                                  placeholder="Adicione informações adicionais sobre seu agendamento..."></textarea>
                        <span asp-validation-for="Observacoes" class="text-danger"></span>
                    </div>

                    <!-- Documentos -->
                    <div class="mb-4">
                        <h5><i class="bi bi-file-earmark-arrow-up"></i> Documentos Necessários</h5>
                        <p class="text-muted">
                            Faça o upload dos documentos solicitados. 
                            Documentos marcados com <span class="badge-rir badge-rir-danger">Obrigatório</span> são necessários.
                        </p>

                        @for (int i = 0; i < Model.Documentos.Count; i++)
                        {
                            <div class="card-rir mb-3">
                                <div class="card-rir-body">
                                    <div class="row align-items-center">
                                        <div class="col-12 col-md-6 mb-3 mb-md-0">
                                            <h6 class="mb-1">
                                                <i class="bi bi-file-earmark-text"></i> @Model.Documentos[i].Nome
                                                @if (Model.Documentos[i].Obrigatorio)
                                                {
                                                    <span class="badge-rir badge-rir-danger ms-2">Obrigatório</span>
                                                }
                                                else
                                                {
                                                    <span class="badge-rir badge-rir-info ms-2">Opcional</span>
                                                }
                                            </h6>
                                            @if (!string.IsNullOrEmpty(Model.Documentos[i].Descricao))
                                            {
                                                <small class="text-muted">@Model.Documentos[i].Descricao</small>
                                            }
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <input type="hidden" asp-for="Documentos[i].DocumentoSolicitadoId" />
                                            <input type="hidden" asp-for="Documentos[i].Nome" />
                                            <input type="hidden" asp-for="Documentos[i].Descricao" />
                                            <input type="hidden" asp-for="Documentos[i].Obrigatorio" />
                                            
                                            <input asp-for="Documentos[i].Arquivo" class="form-control" type="file" 
                                                   accept=".pdf,.jpg,.jpeg,.png" />
                                            <small class="form-text text-muted">
                                                Formatos aceitos: PDF, JPG, PNG (máx. 10MB)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Botões -->
                    <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                        <a asp-action="MeusAgendamentos" class="btn-rir-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" class="btn-rir-primary">
                            <i class="bi bi-check-circle"></i> Criar Agendamento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- CSS e JS do Calendário -->
<link rel="stylesheet" href="~/css/rir-design/calendario.css" />
<script src="~/js/calendario-disponibilidade.js"></script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Definir data mínima como amanhã
        document.addEventListener('DOMContentLoaded', function() {
            var dataHoraInput = document.querySelector('input[type="datetime-local"]');
            if (dataHoraInput) {
                // Data mínima: amanhã
                var tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(8, 0, 0, 0);
                
                // Formatar para datetime-local (YYYY-MM-DDTHH:MM)
                var year = tomorrow.getFullYear();
                var month = String(tomorrow.getMonth() + 1).padStart(2, '0');
                var day = String(tomorrow.getDate()).padStart(2, '0');
                var hours = String(tomorrow.getHours()).padStart(2, '0');
                var minutes = String(tomorrow.getMinutes()).padStart(2, '0');
                
                var minDateTime = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
                dataHoraInput.setAttribute('min', minDateTime);
                
                // Validação ao mudar
                dataHoraInput.addEventListener('change', function() {
                    var selectedDate = new Date(this.value);
                    var dayOfWeek = selectedDate.getDay();
                    var hour = selectedDate.getHours();
                    
                    // Verificar fim de semana
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        alert('Agendamentos só podem ser feitos de segunda a sexta-feira.');
                        this.value = '';
                        return;
                    }
                    
                    // Verificar horário (8h às 18h)
                    if (hour < 8 || hour >= 18) {
                        alert('Agendamentos só podem ser feitos entre 8h e 18h.');
                        this.value = '';
                        return;
                    }
                });
            }
        });

        // Preview dos arquivos selecionados
        document.querySelectorAll('input[type="file"]').forEach(function(input) {
            input.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    var fileName = this.files[0].name;
                    var fileSize = (this.files[0].size / 1024 / 1024).toFixed(2); // MB
                    console.log('Arquivo selecionado: ' + fileName + ' (' + fileSize + ' MB)');
                }
            });
        });
    </script>
}
